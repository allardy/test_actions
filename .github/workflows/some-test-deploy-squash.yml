name: Trigger Production Deploy Squash

on:
  workflow_dispatch:

jobs:
  merge-master-to-prod:
    name: Squash Master into Prod
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout prod branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: prod
          token: ${{ secrets.SECRET }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch master branch
        run: git fetch origin master

      - name: Squash changes from master into prod
        run: |
          # Merge (squash) everything from origin/master,
          # preferring "theirs" on conflict
          git merge --squash origin/master -Xtheirs

          last_squash_commit=$(git log origin/prod --grep="Production Deploy:" --pretty=format:"%H" -n 1)

          # Determine the commit range from that last squash commit to master
          if [ -n "$last_squash_commit" ]; then
            commit_count=$(git rev-list $last_squash_commit..origin/master --count)
            first_commit=$(git rev-list $last_squash_commit..origin/master | tail -n 1 | cut -c1-7)
          else
            # If no previous squash commit is found, assume deploying everything
            commit_count=$(git rev-list origin/master --count)
            first_commit=$(git rev-list origin/master | tail -n 1 | cut -c1-7)
          fi

          # The last commit in master
          last_commit=$(git rev-list origin/master | head -n 1 | cut -c1-7)

          # Start the commit message
          {
            echo "Production Deploy: $commit_count commits ($first_commit â†’ $last_commit)"
            echo
            echo "Included commits:"
            git log HEAD..origin/master --pretty=format:"- %h %s"
          } > /tmp/commitmsg

          # Create the single squash commit
          git commit -F /tmp/commitmsg

      - name: Push new squash commit to prod
        run: |
          git push origin prod --force-with-lease
